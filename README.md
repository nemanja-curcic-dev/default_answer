# default_answer

Generated by `nozzy`!

## Components

### Transports
| **Option** | **Enabled** |
|---|---|
| gRPC server | ![enabled](https://img.icons8.com/color/24/000000/checked.png) |
| gRPC client | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |
| HTTP server | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |
| AMQP consume | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |
| AMQP publish | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |





### Database
| **Option** | **Enabled** |
|---|---|
| MySQL | ![enabled](https://img.icons8.com/color/24/000000/checked.png) |
| MongoDB | ![disabled](https://img.icons8.com/color/24/000000/close-window.png) |

## Structure
For each listening transport (gRPC, HTTP and AMQP (Consume)) there is an file called `<transport>-app.js` in the root
of the `src` folder. These are the entry points of the corresponding apps. All can be used together.

### gRPC
You need to copy the whole folder structure of the microservices you need to communicate with from the
[protobuf](https://bitbucket.org/jdbergmann/protobuf/src/master/) repo to the `src/proto` folder.
E.g. `src/proto/product/authorization/authorization.proto`. Be sure to copy the imported proto files too!

### AMQP
#### proto.js
The file `src/proto/proto.js` is used for encoding and decoding AMQP mesages. You can generate this file by running

```
pbjs -t static-module -w es6 -o proto.js product/authorization/authorization.proto
```

inside the protobuf repo root folder. You can add as many proto files as you like!

### HTTP
Use the generated Swagger module to validate requests and responses. E.g. look at the
[product-api](https://bitbucket.org/jdbergmann/product/src/develop/api/src/routes/web.js) POST /authorization route on
how to use it!

The route `/api-docs/web` exposes the Swagger UI while `api-docs/json` exposes the JSON specification.

### MySQL
Sample migration file (located in `src/db/migrations`). Generate a new one with `knex migrate:make <migration_name>`
```
exports.up = function (knex) {
    return knex.schema.createTable('requests', function (table) {
        table.bigincrements('id').primary();
        table.string('request_id', 50).unique();
        table.bigint('owner_id').notNull().index();
        table.bigint('advert_id').index();
        table.string('requester_ref').notNull().index();
        table.string('message').notNull();
        table.dateTime('created_at').notNull();
        table.dateTime('updated_at').notNull();
        table.dateTime('deleted_at');
    })
};

exports.down = function (knex) {
    knex.schema.dropTable('requests')
};
```

## Web client
https://github.com/fullstorydev/grpcui

### Installation
```
go get github.com/fullstorydev/grpcui
go install github.com/fullstorydev/grpcui/cmd/grpcui
```

### Usage
```
npm run web-client
```

## docker-compose
You can use the following template to add it to the repo's root docker-compose.yml.

```
### default_answer #####################################
  default_answer:
    build:
      context: ./default_answer
      dockerfile: Dockerfile
    ports:
      - "50051:50051"
    environment:
      - TZ=Europe/Zurich
      - GRPC_PORT=50051
      - HTTP_PORT=3000
      - NODE_ENV=development
      - LOG_LEVEL=debug
```
